<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar and Wind Data Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h2>Table-1: Verify Sim</h2>
    <p>This section displays simulated sensor data for verification purposes, loaded from collect1.txt.</p>
    <div id="simTimestamp" class="mt-2 mb-2" style="font-size: 0.9em; color: #666;"></div>
    <div class="mb-3">
        <button id="loadLatestBtn" class="btn btn-primary btn-sm me-2" onclick="loadLatestData()">
            <i class="fas fa-clock"></i> Latest 10 Rows
        </button>
        <button id="loadTopWindBtn" class="btn btn-info btn-sm me-2" onclick="loadTopWindSpeed()">
            <i class="fas fa-wind"></i> Top 10 Wind Speed
        </button>
        <button id="loadTopIrradianceBtn" class="btn btn-warning btn-sm" onclick="loadTopIrradiance()">
            <i class="fas fa-sun"></i> Top 10 Solar Irradiance
        </button>
    </div>
    <table id="simTable">
        <thead>
            <tr>
                <th>LI</th>
                <th>Timestamp</th>
                <th>Temperature (°C)</th>
                <th>Humidity (%)</th>
                <th>Irradiance (W/m²)</th>
                <th>Wind Speed (m/s)</th>
            </tr>
        </thead>
        <tbody id="simTableBody">
            <tr>
                <td colspan="5" style="text-align: center; color: #666;">Click "Load Sim Data" to load simulated sensor data from file</td>
            </tr>
        </tbody>
    </table>

    <h2>Table-2: Live Weather Data (Step 2.1 - OpenWeather API Integration)</h2>
    <p>This section displays real-time weather data fetched from OpenWeather API, including temperature, humidity, and wind speed. Data is updated when the ingestion button is triggered.</p>
    <div class="mb-3">
        <button id="loadWeatherLatestBtn" class="btn btn-primary btn-sm me-2" onclick="loadWeatherLatestData()">
            <i class="fas fa-clock"></i> Latest 10 Rows
        </button>
        <button id="loadWeatherTopWindBtn" class="btn btn-info btn-sm me-2" onclick="loadWeatherTopWindSpeed()">
            <i class="fas fa-wind"></i> Top 10 Wind Speed
        </button>
        <button id="loadWeatherTopTempBtn" class="btn btn-warning btn-sm" onclick="loadWeatherTopTemperature()">
            <i class="fas fa-sun"></i> Top 10 Temperature
        </button>
    </div>
    <div id="weatherDbStatus" class="mt-3" style="display: none;">
        <div id="weatherDbMessage" class="alert"></div>
    </div>
    <table id="weatherTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Temperature (°C)</th>
                <th>Humidity (%)</th>
                <th>Solar Irradiance (W/m²)</th>
                <th>Wind Speed (m/s)</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody id="weatherTableBody">
            <tr>
                <td colspan="6" style="text-align: center; color: #666;">Click "Trigger Data Ingestion" to fetch live weather data or "Load Weather Data from Database" to view stored data</td>
            </tr>
        </tbody>
    </table>

    <h2>Table-3: NASA POWER Solar Irradiance Data (Step 2.2 - NASA POWER API Integration)</h2>
    <p>This section displays real-time solar irradiance data fetched from NASA POWER API, including 10 data points from the past 2 days. Data is updated when the ingestion button is triggered.</p>
    <table id="nasaPowerTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Solar Irradiance (W/m²)</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody id="nasaPowerTableBody">
            <tr>
                <td colspan="3" style="text-align: center; color: #666;">Click "Trigger Data Ingestion" to fetch live NASA POWER solar irradiance data</td>
            </tr>
        </tbody>
    </table>

    <!-- Manual Ingestion Trigger Section -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h3>Manual Data Ingestion</h3>
                <p>Click the button below to trigger on-demand data ingestion from sensors and weather APIs.</p>
                <button id="triggerIngestionBtn" class="btn btn-primary btn-lg" onclick="triggerIngestion()">
                    <i class="fas fa-play"></i> Trigger Data Ingestion
                </button>
                <div id="ingestionStatus" class="mt-3" style="display: none;">
                    <div id="statusMessage" class="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 8 Steps Section -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h3>Phase 8: Real-Time Data Collection Steps</h3>
                <p>Follow the step-by-step guide for testing Phase 8 features. Click each button to perform the corresponding action.</p>

                <div class="step-section mb-4">
                    <h4>Step 1: Prepare Your Environment</h4>
                    <button id="startFlaskBtn" class="btn btn-primary btn-sm me-2" onclick="startFlaskServer()">
                        <i class="fas fa-server"></i> Start Flask Web Server
                    </button>
                    <button id="launchServerBtn" class="btn btn-success btn-sm me-2" onclick="launchFlaskServer()">
                        <i class="fas fa-rocket"></i> Launch Flask Server
                    </button>
                    <button id="checkPostgresBtn" class="btn btn-info btn-sm me-2" onclick="checkPostgresStatus()">
                        <i class="fas fa-database"></i> Check PostgreSQL Status
                    </button>
                    <button id="verifyDbBtn" class="btn btn-info btn-sm" onclick="verifyDbConnection()">
                        <i class="fas fa-link"></i> Verify DB Connection
                    </button>
                    <div id="envStatus" class="mt-3" style="display: none;">
                        <div id="envMessage" class="alert"></div>
                    </div>
                </div>

                <div class="step-section mb-4">
                    <h4>Step 2: Test Manual Data Collection</h4>
                    <p>Manual collection is handled by the "Trigger Data Ingestion" button above.</p>
                    <button id="fetchOpenWeatherBtn" class="btn btn-primary btn-sm me-2" onclick="fetchOpenWeather()">
                        <i class="fas fa-cloud-sun"></i> Fetch OpenWeather Data
                    </button>
                    <div id="openWeatherStatus" class="mt-3" style="display: none;">
                        <div id="openWeatherMessage" class="alert"></div>
                    </div>
                </div>

                <div class="step-section mb-4">
                    <h4>Step 3: Test Automatic Data Collection</h4>
                    <button id="testAutoBtn" class="btn btn-warning btn-sm" onclick="testAutomaticIngestion()">
                        <i class="fas fa-clock"></i> Test Automatic Ingestion
                    </button>
                    <div id="autoStatus" class="mt-3" style="display: none;">
                        <div id="autoMessage" class="alert"></div>
                    </div>
                </div>

                <div class="step-section mb-4">
                    <h4>Step 4: View Your Data in the Web Interface</h4>
                    <button id="startStreamlitBtn" class="btn btn-success btn-sm me-2" onclick="startStreamlit()">
                        <i class="fas fa-chart-line"></i> Start Streamlit Dashboard
                    </button>
                    <button id="viewHtmlTableBtn" class="btn btn-success btn-sm" onclick="viewHtmlTable()">
                        <i class="fas fa-table"></i> View HTML Table
                    </button>
                    <div id="viewStatus" class="mt-3" style="display: none;">
                        <div id="viewMessage" class="alert"></div>
                    </div>
                </div>

                <div class="step-section mb-4">
                    <h4>Step 5: Check Logs and Verify Everything Worked</h4>
                    <button id="viewLogsBtn" class="btn btn-secondary btn-sm me-2" onclick="viewLogs()">
                        <i class="fas fa-file-alt"></i> View Ingestion Logs
                    </button>
                    <button id="finalDbCheckBtn" class="btn btn-secondary btn-sm" onclick="finalDbCheck()">
                        <i class="fas fa-check-circle"></i> Final DB Check
                    </button>
                    <div id="logsStatus" class="mt-3" style="display: none;">
                        <div id="logsMessage" class="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for data loading and ingestion trigger -->
    <script>
        let dataCollection = {};
        let lastUpdateTimestamp = '';
        let lastSimData = [];

        async function loadDataCollection() {
            try {
                const response = await fetch('/data/collect1.txt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();

                // Parse the file content
                const lines = text.split('\n');
                let currentSection = '';
                let timestamp = '';

                // Extract timestamp from first line
                if (lines[0] && lines[0].startsWith('# Data collection last updated:')) {
                    timestamp = lines[0].replace('# Data collection last updated: ', '');
                    lastUpdateTimestamp = timestamp;
                }

                dataCollection = { sim: [], nasa_power: [], openweather: [] };

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.slice(1, -1).toLowerCase().replace(' ', '_');
                    } else if (line && !line.startsWith('timestamp,') && currentSection) {
                        const parts = line.split(',');
                        if (parts.length === 5 && currentSection in dataCollection) {
                            const row = {
                                timestamp: parts[0],
                                temperature: parseFloat(parts[1]),
                                humidity: parseFloat(parts[2]),
                                irradiance: parseFloat(parts[3]),
                                wind_speed: parseFloat(parts[4])
                            };
                            dataCollection[currentSection].push(row);
                        }
                    }
                }

                console.log('Data collection loaded:', dataCollection);
                return true;
            } catch (error) {
                console.error('Error loading data collection:', error);
                logError('Data Loading', 'File Load Error', `Failed to load data_collection.txt: ${error.message}`, 'Error');
                return false;
            }
        }

        async function triggerIngestion() {
            const btn = document.getElementById('triggerIngestionBtn');
            const statusDiv = document.getElementById('ingestionStatus');
            const statusMessage = document.getElementById('statusMessage');

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Triggering data ingestion...';

            try {
                const response = await fetch('/trigger_ingestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `
                        <strong>Success!</strong> Data ingestion completed.<br>
                        - Sensor data generated: ${result.sensor_generated ? 'Yes' : 'No'}<br>
                        - Weather data fetched: ${result.weather_fetched ? 'Yes' : 'No'}<br>
                        - New rows added: ${result.ingestion_result.new_rows || 0}
                    `;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerHTML = `<strong>Error:</strong> ${result.error || 'Unknown error occurred'}`;
                }

            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Network Error:</strong> ${error.message}`;
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Trigger Data Ingestion';
            }
        }

        async function startFlaskServer() {
            const btn = document.getElementById('startFlaskBtn');
            const statusDiv = document.getElementById('envStatus');
            const statusMessage = document.getElementById('envMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Starting Flask web server...';

            try {
                // Since we're already on the page, the server is running
                statusMessage.className = 'alert alert-success';
                statusMessage.innerHTML = '<strong>Flask Web Server:</strong> Already running (you are viewing this page!)';
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-server"></i> Start Flask Web Server';
            }
        }

        async function launchFlaskServer() {
            const btn = document.getElementById('launchServerBtn');
            const statusDiv = document.getElementById('envStatus');
            const statusMessage = document.getElementById('envMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Launching...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Launching Flask server...';

            try {
                // Since we can't start Flask from within Flask, show instructions
                statusMessage.className = 'alert alert-warning';
                statusMessage.innerHTML = `<strong>Manual Server Launch Required:</strong><br>
                    Please open Command Prompt and run:<br>
                    <code>cd "d:/My Documents/ee/1_Tester_cee/AI/AI-EnergyR5/web"<br>
                    python ingestion_trigger.py</code><br>
                    Then refresh this page to access all features.`;
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket"></i> Launch Flask Server';
            }
        }

        async function checkPostgresStatus() {
            const btn = document.getElementById('checkPostgresBtn');
            const statusDiv = document.getElementById('envStatus');
            const statusMessage = document.getElementById('envMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Checking PostgreSQL status...';

            try {
                const response = await fetch('/check_postgres_status');
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>PostgreSQL Status:</strong> ${result.status}<br>${result.message}`;
                } else {
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.innerHTML = `<strong>PostgreSQL Status:</strong> ${result.status}<br>${result.message}`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-database"></i> Check PostgreSQL Status';
            }
        }

        async function verifyDbConnection() {
            const btn = document.getElementById('verifyDbBtn');
            const statusDiv = document.getElementById('envStatus');
            const statusMessage = document.getElementById('envMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Verifying database connection...';

            try {
                const response = await fetch('/verify_db_connection');
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Database Connection:</strong> Success<br><pre>${result.output}</pre>`;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerHTML = `<strong>Database Connection:</strong> Failed<br><pre>${result.error}</pre>`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-link"></i> Verify DB Connection';
            }
        }

        async function testAutomaticIngestion() {
            const btn = document.getElementById('testAutoBtn');
            const statusDiv = document.getElementById('autoStatus');
            const statusMessage = document.getElementById('autoMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Testing automatic ingestion...';

            try {
                const response = await fetch('/test_automatic_ingestion', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Automatic Ingestion Result:</strong><br>
                        Message: ${result.message || 'N/A'}<br>
                        Total Rows: ${result.total_rows || 0}<br>
                        Time Range: ${result.time_range || 'N/A'}`;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerHTML = `<strong>Error:</strong> ${result.error}`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-clock"></i> Test Automatic Ingestion';
            }
        }

        async function startStreamlit() {
            const btn = document.getElementById('startStreamlitBtn');
            const statusDiv = document.getElementById('viewStatus');
            const statusMessage = document.getElementById('viewMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Starting Streamlit dashboard...';

            try {
                const response = await fetch('/start_streamlit', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Streamlit Dashboard:</strong> ${result.message}`;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerHTML = `<strong>Error:</strong> ${result.error}`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-line"></i> Start Streamlit Dashboard';
            }
        }

        function viewHtmlTable() {
            const statusDiv = document.getElementById('viewStatus');
            const statusMessage = document.getElementById('viewMessage');

            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'HTML table is already displayed above. You can also run <code>python generate_html_table.py</code> for a separate view.';
        }

        async function viewLogs() {
            const btn = document.getElementById('viewLogsBtn');
            const statusDiv = document.getElementById('logsStatus');
            const statusMessage = document.getElementById('logsMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Loading ingestion logs...';

            try {
                const response = await fetch('/view_logs');
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Ingestion Logs:</strong><br><pre style="max-height: 300px; overflow-y: auto;">${result.logs}</pre>`;
                } else {
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.innerHTML = `<strong>Logs:</strong> ${result.error}`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-alt"></i> View Ingestion Logs';
            }
        }

        async function fetchOpenWeather() {
            const btn = document.getElementById('fetchOpenWeatherBtn');
            const statusDiv = document.getElementById('openWeatherStatus');
            const statusMessage = document.getElementById('openWeatherMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Fetching weather data from OpenWeather API...';

            try {
                const response = await fetch('/fetch_openweather', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>OpenWeather API Fetch:</strong> Success<br>
                        - Weather data fetched: ${result.weather_fetched ? 'Yes' : 'No'}<br>
                        - Data points collected: ${result.weather_data_points || 0}<br>
                        - Rows inserted into database: ${result.weather_rows_inserted || 0}`;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerHTML = `<strong>Error:</strong> ${result.error}`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Network Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-sun"></i> Fetch OpenWeather Data';
            }
        }

        async function finalDbCheck() {
            const btn = document.getElementById('finalDbCheckBtn');
            const statusDiv = document.getElementById('logsStatus');
            const statusMessage = document.getElementById('logsMessage');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Performing final database check...';

            try {
                const response = await fetch('/final_db_check');
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Final Database Check:</strong> Success<br><pre>${result.output}</pre>`;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerHTML = `<strong>Final Database Check:</strong> Failed<br><pre>${result.error}</pre>`;
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Final DB Check';
            }
        }

        async function loadLatestData() {
            const btn = document.getElementById('loadLatestBtn');
            const tableBody = document.getElementById('simTableBody');
            const timestampDiv = document.getElementById('simTimestamp');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const success = await loadDataCollection();
                if (success && dataCollection.sim && dataCollection.sim.length > 0) {
                    // Display timestamp
                    if (lastUpdateTimestamp) {
                        timestampDiv.innerHTML = `<strong>Last updated:</strong> ${lastUpdateTimestamp}`;
                    }

                    // Sort sim data by timestamp descending and get the latest 10 rows
                    const sortedSimData = dataCollection.sim.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const last10Rows = sortedSimData.slice(0, 10);

                    // Populate the table
                    tableBody.innerHTML = last10Rows.map((row, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${row.timestamp}</td>
                            <td>${row.temperature.toFixed(2)}</td>
                            <td>${row.humidity.toFixed(2)}</td>
                            <td>${row.irradiance.toFixed(2)}</td>
                            <td>${row.wind_speed.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    console.log('Latest sim data loaded');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No sim data found in file</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Error loading sim data</td></tr>';
                logError('Sim Data Loading', 'Load Error', error.message, 'Error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-clock"></i> Latest 10 Rows';
            }
        }

        async function loadTopWindSpeed() {
            const btn = document.getElementById('loadTopWindBtn');
            const tableBody = document.getElementById('simTableBody');
            const timestampDiv = document.getElementById('simTimestamp');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const success = await loadDataCollection();
                if (success && dataCollection.sim && dataCollection.sim.length > 0) {
                    // Display timestamp
                    if (lastUpdateTimestamp) {
                        timestampDiv.innerHTML = `<strong>Last updated:</strong> ${lastUpdateTimestamp}`;
                    }

                    // Sort sim data by wind speed descending and get the top 10 rows
                    const sortedSimData = dataCollection.sim.sort((a, b) => b.wind_speed - a.wind_speed);
                    const top10Rows = sortedSimData.slice(0, 10);

                    // Populate the table
                    tableBody.innerHTML = top10Rows.map((row, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${row.timestamp}</td>
                            <td>${row.temperature.toFixed(2)}</td>
                            <td>${row.humidity.toFixed(2)}</td>
                            <td>${row.irradiance.toFixed(2)}</td>
                            <td>${row.wind_speed.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    console.log('Top wind speed sim data loaded');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No sim data found in file</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Error loading sim data</td></tr>';
                logError('Sim Data Loading', 'Load Error', error.message, 'Error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wind"></i> Top 10 Wind Speed';
            }
        }

        async function loadTopIrradiance() {
            const btn = document.getElementById('loadTopIrradianceBtn');
            const tableBody = document.getElementById('simTableBody');
            const timestampDiv = document.getElementById('simTimestamp');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const success = await loadDataCollection();
                if (success && dataCollection.sim && dataCollection.sim.length > 0) {
                    // Display timestamp
                    if (lastUpdateTimestamp) {
                        timestampDiv.innerHTML = `<strong>Last updated:</strong> ${lastUpdateTimestamp}`;
                    }

                    // Sort sim data by irradiance descending and get the top 10 rows
                    const sortedSimData = dataCollection.sim.sort((a, b) => b.irradiance - a.irradiance);
                    const top10Rows = sortedSimData.slice(0, 10);

                    // Populate the table
                    tableBody.innerHTML = top10Rows.map((row, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${row.timestamp}</td>
                            <td>${row.temperature.toFixed(2)}</td>
                            <td>${row.humidity.toFixed(2)}</td>
                            <td>${row.irradiance.toFixed(2)}</td>
                            <td>${row.wind_speed.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    console.log('Top irradiance sim data loaded');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No sim data found in file</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Error loading sim data</td></tr>';
                logError('Sim Data Loading', 'Load Error', error.message, 'Error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sun"></i> Top 10 Solar Irradiance';
            }
        }

        async function loadWeatherFromFile() {
            const btn = document.getElementById('loadWeatherFromDbBtn');
            const statusDiv = document.getElementById('weatherDbStatus');
            const statusMessage = document.getElementById('weatherDbMessage');
            const tableBody = document.getElementById('weatherTableBody');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Loading weather data from file...';

            try {
                const success = await loadDataCollection();
                if (success && dataCollection.group_openweather && dataCollection.group_openweather.length > 0) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Weather Data Loaded:</strong> ${dataCollection.group_openweather.length} records retrieved from file`;

                    // Populate the table
                    tableBody.innerHTML = dataCollection.group_openweather.map(row => `
                        <tr>
                            <td>${row.timestamp}</td>
                            <td>${row.temperature.toFixed(2)}</td>
                            <td>${row.humidity.toFixed(2)}</td>
                            <td>${row.wind_speed.toFixed(2)}</td>
                            <td>group openweather</td>
                        </tr>
                    `).join('');
                } else {
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.innerHTML = '<strong>No Data Found:</strong> No weather data available in file';
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No weather data found in file</td></tr>';
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Error loading data from file</td></tr>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-database"></i> Load Weather Data from File';
            }
        }

        async function loadNasaPowerData() {
            const tableBody = document.getElementById('nasaPowerTableBody');

            try {
                const success = await loadDataCollection();
                if (success && dataCollection.nasa_power && dataCollection.nasa_power.length > 0) {
                    // Populate the table
                    tableBody.innerHTML = dataCollection.nasa_power.map(row => `
                        <tr>
                            <td>${row.timestamp}</td>
                            <td>${row.irradiance.toFixed(2)}</td>
                            <td>nasa_power</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">No NASA Power data found in file</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">Error loading NASA Power data</td></tr>';
                logError('NASA Power Data Loading', 'Load Error', error.message, 'Error');
            }
        }

        async function loadWeatherFromDb() {
            const btn = document.getElementById('loadWeatherFromDbBtn');
            const statusDiv = document.getElementById('weatherDbStatus');
            const statusMessage = document.getElementById('weatherDbMessage');
            const tableBody = document.getElementById('weatherTableBody');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            statusDiv.style.display = 'block';
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = 'Loading weather data from database...';

            try {
                const response = await fetch('/get_weather_data_from_db');
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerHTML = `<strong>Weather Data Loaded:</strong> ${result.count} records retrieved from database`;

                    // Populate the table
                    tableBody.innerHTML = result.data.map(row => `
                        <tr>
                            <td>${row.timestamp}</td>
                            <td>${row.temperature.toFixed(2)}</td>
                            <td>${row.humidity.toFixed(2)}</td>
                            <td>${row.wind_speed.toFixed(2)}</td>
                            <td>${row.source}</td>
                        </tr>
                    `).join('');
                } else {
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.innerHTML = `<strong>No Data Found:</strong> ${result.error || 'No weather data available in database'}`;
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No weather data found in database</td></tr>';
                }
            } catch (error) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Error loading data from database</td></tr>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-database"></i> Load Weather Data from Database';
            }
        }
    </script>

    <!-- Error Logs Section -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h3>Error Logs and Troubleshooting</h3>
                <p>The following rows display real-time error logs and troubleshooting information:</p>

                <div class="error-logs-table">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Component</th>
                                <th>Error Type</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="errorLogsTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">No errors logged yet. Errors will appear here in real-time.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <button id="clearLogsBtn" class="btn btn-warning btn-sm" onclick="clearErrorLogs()">
                        <i class="fas fa-trash"></i> Clear Error Logs
                    </button>
                    <button id="refreshLogsBtn" class="btn btn-info btn-sm ms-2" onclick="refreshErrorLogs()">
                        <i class="fas fa-sync"></i> Refresh Logs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Error logging functionality
        let errorLogs = [];

        function logError(component, errorType, message, status = 'Error') {
            const timestamp = new Date().toLocaleString();
            const errorEntry = {
                timestamp: timestamp,
                component: component,
                errorType: errorType,
                message: message,
                status: status
            };

            errorLogs.unshift(errorEntry); // Add to beginning of array

            // Keep only last 100 entries
            if (errorLogs.length > 100) {
                errorLogs = errorLogs.slice(0, 100);
            }

            updateErrorLogsDisplay();
        }

        function updateErrorLogsDisplay() {
            const tbody = document.getElementById('errorLogsTableBody');

            if (errorLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No errors logged yet. Errors will appear here in real-time.</td></tr>';
                return;
            }

            tbody.innerHTML = errorLogs.map(log => `
                <tr class="${log.status === 'Error' ? 'table-danger' : log.status === 'Warning' ? 'table-warning' : 'table-info'}">
                    <td>${log.timestamp}</td>
                    <td>${log.component}</td>
                    <td>${log.errorType}</td>
                    <td>${log.message}</td>
                    <td><span class="badge bg-${log.status === 'Error' ? 'danger' : log.status === 'Warning' ? 'warning' : 'info'}">${log.status}</span></td>
                </tr>
            `).join('');
        }

        function clearErrorLogs() {
            errorLogs = [];
            updateErrorLogsDisplay();
        }

        function refreshErrorLogs() {
            updateErrorLogsDisplay();
        }

        // Auto-load data on page load
        window.onload = function() {
            loadNasaPowerData();
            loadSimData(); // Auto-load sim data on page load
        };

        // Override existing functions to add error logging
        const originalTriggerIngestion = window.triggerIngestion;
        window.triggerIngestion = async function() {
            try {
                await originalTriggerIngestion();
                logError('Data Ingestion', 'Success', 'Data ingestion completed successfully', 'Success');
            } catch (error) {
                logError('Data Ingestion', 'Network Error', error.message, 'Error');
                throw error;
            }
        };

        const originalCheckPostgresStatus = window.checkPostgresStatus;
        window.checkPostgresStatus = async function() {
            try {
                await originalCheckPostgresStatus();
            } catch (error) {
                logError('PostgreSQL', 'Connection Error', error.message, 'Error');
                throw error;
            }
        };

        const originalVerifyDbConnection = window.verifyDbConnection;
        window.verifyDbConnection = async function() {
            try {
                await originalVerifyDbConnection();
            } catch (error) {
                logError('Database', 'Connection Error', error.message, 'Error');
                throw error;
            }
        };

        const originalTestAutomaticIngestion = window.testAutomaticIngestion;
        window.testAutomaticIngestion = async function() {
            try {
                await originalTestAutomaticIngestion();
            } catch (error) {
                logError('Automatic Ingestion', 'Test Error', error.message, 'Error');
                throw error;
            }
        };

        const originalStartStreamlit = window.startStreamlit;
        window.startStreamlit = async function() {
            try {
                await originalStartStreamlit();
            } catch (error) {
                logError('Streamlit', 'Startup Error', error.message, 'Error');
                throw error;
            }
        };

        const originalViewLogs = window.viewLogs;
        window.viewLogs = async function() {
            try {
                await originalViewLogs();
            } catch (error) {
                logError('Log Viewer', 'Load Error', error.message, 'Error');
                throw error;
            }
        };

        const originalFinalDbCheck = window.finalDbCheck;
        window.finalDbCheck = async function() {
            try {
                await originalFinalDbCheck();
            } catch (error) {
                logError('Database', 'Final Check Error', error.message, 'Error');
                throw error;
            }
        };
    </script>
</body>
</html>
